<div>
  <audio id="hero-radio" autoplay muted></audio>
</div>
<script>
  (async () => {
    let headers = new Headers();
    headers.append("Access-Control-Allow-Origin", "https://fn5r5boclg.preview.infomaniak.website");

    const response = await fetch(
      "https://fn5r5boclg.preview.infomaniak.website/public/radio/radio_audios_list.txt",
      { headers }
    );

    const { audios } = await response.json();

    const date = new Date();
    const secondsFromToday = date.getHours() * 3600 + date.getMinutes() * 60 + date.getSeconds();

    const totalAudiosDuration = audios.reduce((acc, audio) => acc + audio.durationInSeconds, 0);
    const currentGlobalSecond = secondsFromToday % totalAudiosDuration;

    let cumulative = 0;
    let audioToPlay;
    let startAt = 0;

    for (let i = 0; i < audios.length; i++) {
      cumulative += audios[i].durationInSeconds;
      if (cumulative > currentGlobalSecond) {
        audioToPlay = audios[i];
        startAt = audios[i].durationInSeconds - (cumulative - currentGlobalSecond);
        const artistName = document.getElementById("artist-name");
        if (artistName) {
          artistName.textContent = audioToPlay.artist || "Artiste inconnu";
        }
        break;
      }
    }

    const audioElement = document.getElementById("hero-radio");
    audioElement.src = audioToPlay.url;
    audioElement.load();

    let currentIndex = audios.findIndex((audio) => audio.url === audioToPlay.url);

    audioElement.addEventListener("ended", () => {
      currentIndex = (currentIndex + 1) % audios.length;
      const nextAudio = audios[currentIndex];
      audioElement.src = nextAudio.url;
      const artistName = document.getElementById("artist-name");
      if (artistName) {
        artistName.textContent = nextAudio.artist || "Artiste inconnu";
      }
      audioElement.load();
      audioElement.addEventListener(
        "loadedmetadata",
        () => {
          audioElement.currentTime = 0;
          audioElement.play();
        },
        { once: true }
      );
    });

    audioElement.addEventListener("loadedmetadata", () => {
      audioElement.currentTime = startAt;
      audioElement.play();
    });

    const radioPlayer = document.getElementById("radio-player-container");
    const activateRadio = document.getElementById("activate-live");
    activateRadio.addEventListener("click", () => {
      audioElement.muted = false;
      audioElement.play();
      activateRadio.style.display = "none";
      radioPlayer.style.display = "flex";
    });

    const toggleButton = document.getElementById("activate-sound");
    toggleButton.addEventListener("click", () => {
      if (audioElement.muted) {
        audioElement.muted = false;
        audioElement.play();
      } else {
        audioElement.muted = true;
      }
    });
  })();
</script>
