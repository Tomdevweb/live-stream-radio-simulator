<div>
  <audio id="hero-radio" controls muted></audio>
</div>

<script>
  (async () => {
    const headers = new Headers();
    headers.append("Access-Control-Allow-Origin", "https://fn5r5boclg.preview.infomaniak.website");

    const response = await fetch(
      "https://fn5r5boclg.preview.infomaniak.website/public/radio/radio_audios_list.txt",
      { headers }
    );

    const { audios } = await response.json();

    const audioElement = document.getElementById("hero-radio");
    const radioPlayer = document.getElementById("radio-player-container");
    const activateRadio = document.getElementById("activate-live");
    const toggleButton = document.getElementById("activate-sound");
    const artistName = document.getElementById("artist-name");

    let currentIndex = 0;

    audioElement.addEventListener("ended", () => {
      currentIndex = (currentIndex + 1) % audios.length;
      const nextAudio = audios[currentIndex];
      audioElement.src = nextAudio.url;

      if (artistName) artistName.textContent = nextAudio.artist || "Artiste inconnu";

      audioElement.load();
      audioElement.addEventListener(
        "loadedmetadata",
        () => {
          audioElement.currentTime = 0;
          audioElement.play();
        },
        { once: true }
      );
    });

    const loader = document.getElementById("radio-loader");

    if (activateRadio) {
      activateRadio.addEventListener("click", async () => {
        try {
          if (loader) loader.style.display = "block";

          const date = new Date();
          const secondsFromToday =
            date.getHours() * 3600 + date.getMinutes() * 60 + date.getSeconds();
          const totalAudiosDuration = audios.reduce(
            (acc, audio) => acc + audio.durationInSeconds,
            0
          );
          const currentGlobalSecond = secondsFromToday % totalAudiosDuration;

          let cumulative = 0;
          let audioToPlay = null;
          let startAt = 0;

          for (let i = 0; i < audios.length; i++) {
            cumulative += audios[i].durationInSeconds;
            if (cumulative > currentGlobalSecond) {
              audioToPlay = audios[i];
              startAt = audioToPlay.durationInSeconds - (cumulative - currentGlobalSecond);
              currentIndex = i;
              if (artistName) artistName.textContent = audioToPlay.artist || "Artiste inconnu";
              break;
            }
          }

          audioElement.src = audioToPlay.url;
          audioElement.load();

          // Wait for audio to be ready before seek
          audioElement.addEventListener("loadedmetadata", function onLoaded() {
            audioElement.removeEventListener("loadedmetadata", onLoaded);
            audioElement.currentTime = startAt;

            audioElement
              .play()
              .then(() => {
                audioElement.muted = false;
                activateRadio.style.display = "none";
                if (radioPlayer) radioPlayer.style.display = "flex";
                if (loader) loader.style.display = "none";
              })
              .catch((err) => {
                console.warn("Erreur de lecture :", err);
                if (loader) loader.style.display = "none";
              });
          });

          // Need for Safari to unlock events
          await audioElement.play();
          audioElement.pause();
        } catch (err) {
          console.warn("Erreur Safari iOS :", err);
          if (loader) loader.style.display = "none";
        }
      });
    }

    if (toggleButton) {
      toggleButton.addEventListener("click", () => {
        audioElement.muted = !audioElement.muted;
      });
    }
  })();
</script>
